<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Robin's Pokemon Sleep Rater</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <head>
        
    <body>
        <h1>Robin's Pokemon Sleep Rater</h1>



        <!-- <py-script src="./main.py"></py-script> -->
    

        <label for="species">Select a Pokemon:</label>
        <select id="species" onchange="updateOptions('species', 'ing30', 'ing60')">
        </select>
        <br>

        <label for="nature">Nature:</label>
        <select id="nature">
        </select>
        <br>

        <label for="ss10">Lvl 10 subskill:</label>
        <select id="ss10">
        </select>
        <br>

        <label for="ss25">Lvl 25 subskill:</label>
        <select id="ss25">
        </select>
        <br>

        <label for="ss50">Lvl 50 subskill:</label>
        <select id="ss50">
        </select>
        <br>

        <label for="ss75">Lvl 75 subskill:</label>
        <select id="ss75">
        </select>
        <br>

        <label for="ss100">Lvl 100 subskill:</label>
        <select id="ss100">
        </select>
        <br>

        <label for="ing30">Lvl 30 ingredient:</label>
        <select id="ing30" disabled>
        </select>
        <br>

        <label for="ing60">Lvl 60 ingredient:</label>
        <select id="ing60" disabled>
        </select>
        <br>

        <button py-click="evaluate()">Evaluate</button>
        <br>

        <div id="warning"></div>
        <div id="score"></div>

    </body>

<script>
    // Define data array
    var all_species = [
        '', 'Bulbasaur', 'Ivysaur', 'Venusaur','Charmander', 'Charmeleon', 
        'Charizard','Squirtle', 'Wartortle', 'Blastoise','Caterpie', 'Metapod', 
        'Butterfree','Rattata', 'Raticate','Ekans', 'Arbok','Pikachu', 'Raichu',
        'Pikachu - Halloween','Pikachu - Holiday','Clefairy', 'Clefable',
        'Jigglypuff', 'Wigglytuff','Diglett', 'Dugtrio','Meowth', 'Persian',
        'Psyduck', 'Golduck','Mankey', 'Primeape','Growlithe', 'Arcanine',
        'Bellsprout', 'Weepinbell', 'Victreebel','Geodude', 'Graveler', 'Golem',
        'Slowpoke', 'Slowbro','Magnemite', 'Magneton','Doduo', 'Dodrio','Gastly', 
        'Haunter', 'Gengar','Onix','Cubone', 'Marowak','Kangaskhan','Mr. Mime',
        'Pinsir','Ditto','Eevee', 'Vaporeon', 'Jolteon', 'Flareon','Chikorita', 
        'Bayleef', 'Meganium','Cyndaquil', 'Quilava', 'Typhlosion','Totodile', 
        'Croconaw', 'Feraligatr','Pichu','Cleffa','Igglybuff','Togepi', 'Togetic',
        'Mareep', 'Flaaffy', 'Ampharos','Sudowoodo','Espeon', 'Umbreon','Slowking',
        'Wobbuffet','Steelix','Heracross','Delibird','Houndour', 'Houndoom',
        'Larvitar', 'Pupitar', 'Tyranitar','Slakoth', 'Vigoroth', 'Slaking',
        'Sableye','Gulpin', 'Swalot','Swablu', 'Altaria','Shuppet', 'Banette',
        'Absol','Wynaut','Spheal', 'Sealeo', 'Walrein','Bonsly','Mime Jr.',
        'Riolu', 'Lucario','Croagunk', 'Toxicroak','Snover', 'Abomasnow',
        'Magnezone','Togekiss','Leafeon', 'Glaceon','Sylveon'
    ];

    var all_natures = [
        '', 'Adamant','Bashful','Bold','Brave','Calm','Careful','Docile',
        'Gentle','Hardy','Hasty','Impish','Jolly','Lax','Lonely','Mild',
        'Modest','Naive','Naughty','Quiet','Quirky','Rash','Relaxed',
        'Sassy','Serious','Timid'
    ]

    var all_subskills = [
        '','Berry Finding S', 'Dream Shard Bonus','Energy Recovery Bonus',
        'Helping Bonus', 'Helping Speed S', 'Helping Speed M',
        'Ingredient Finder S', 'Ingredient Finder M','Inventory Up S', 
        'Inventory Up M', 'Inventory Up L','Research EXP Bonus',
        'Skill Level Up S', 'Skill Level Up M', 'Skill Trigger S', 
        'Skill Trigger M','Sleep EXP Bonus'
    ]

    var all_ingredients = [
        '', 'Large Leek', 'Tasty Mushroom', 'Fancy Egg', 'Soft Potato', 
        'Fancy Apple','Fiery Herb', 'Bean Sausage', 'Moomoo Milk', 'Honey', 
        'Pure Oil','Warming Ginger', 'Snoozy Tomato', 'Soothing Cacao', 
        'Slowpoke Tail','Greengrass Soybeans'
    ]

    var ing_species = [
        'Bulbasaur', 'Ivysaur', 'Venusaur','Charmander', 'Charmeleon', 
        'Charizard','Squirtle', 'Wartortle', 'Blastoise','Diglett', 'Dugtrio',
        'Bellsprout', 'Weepinbell', 'Victreebel','Geodude', 'Graveler', 'Golem',
        'Slowpoke', 'Slowbro','Gastly','Haunter', 'Gengar','Kangaskhan','Mr. Mime',
        'Pinsir','Ditto','Slowking','Delibird', 'Larvitar', 'Pupitar', 'Tyranitar',
        'Absol','Mime Jr.','Croagunk', 'Toxicroak','Snover', 'Abomasnow'
    ]

    // Function to populate select dropdown
    function populateSelect(elementId, data) {
        var selectElement = document.getElementById(elementId);

        // Clear existing options
        selectElement.innerHTML = '';

        // Add options from data array
        data.forEach(function(item) {
            console.log(item)
            var option = document.createElement('option');
            option.value = item;
            option.text = item;
            selectElement.add(option);
        });
    }

    // Function to update options based on selected species
    function updateOptions(species, ing30, ing60) {
        var selected_species = document.getElementById(species).value;
        var ing30 = document.getElementById(ing30);
        var ing60 = document.getElementById(ing60);

        // Enable/disable ing30 based on the selected species
        ing30.disabled = !ing_species.includes(selected_species);
        ing30.selectedIndex = 0; // Reset selection

        // Enable/disable ing60 based on the selected species
        ing60.disabled = !ing_species.includes(selected_species);
        ing60.selectedIndex = 0; // Reset selection
    }

    // Initial population of species
    populateSelect('species', all_species.sort());
    populateSelect('nature', all_natures);
    var subskills = ['ss10','ss25','ss50','ss75','ss100']
    for (let i = 0; i < subskills.length; i++) {
        populateSelect(subskills[i], all_subskills)
    }
    var ingredients = ['ing30', 'ing60']
    for (let i = 0; i < ingredients.length; i++) {
        populateSelect(ingredients[i], all_ingredients)
    }


</script>

<py-script>
    import datetime as dt
    import math

    class pokemonRater():
        SPECIES_TO_SPECIALTY = {
            'Bulbasaur':'Ingredient', 'Ivysaur':'Ingredient', 'Venusaur':'Ingredient',
            'Charmander':'Ingredient', 'Charmeleon':'Ingredient', 'Charizard':'Ingredient',
            'Squirtle':'Ingredient', 'Wartortle':'Ingredient', 'Blastoise':'Ingredient',
            'Caterpie':'Berry', 'Metapod':'Berry', 'Butterfree':'Berry',
            'Rattata':'Berry', 'Raticate':'Berry','Ekans':'Berry', 
            'Arbok':'Berry','Pikachu':'Berry', 'Raichu':'Berry',
            'Pikachu - Halloween':'Berry','Pikachu - Holiday':'Skill','Clefairy':'Berry', 
            'Clefable':'Berry','Jigglypuff':'Skill', 'Wigglytuff':'Skill',
            'Diglett':'Ingredient', 'Dugtrio':'Ingredient','Meowth':'Skill', 
            'Persian':'Skill', 'Psyduck':'Skill', 'Golduck':'Skill',
            'Mankey':'Berry', 'Primeape':'Berry','Growlithe':'Skill', 
            'Arcanine':'Skill','Bellsprout':'Ingredient', 'Weepinbell':'Ingredient', 
            'Victreebel':'Ingredient','Geodude':'Ingredient', 'Graveler':'Ingredient', 
            'Golem':'Ingredient', 'Slowpoke':'Ingredient', 'Slowbro':'Ingredient',
            'Magnemite':'Skill', 'Magneton':'Skill','Doduo':'Berry', 
            'Dodrio':'Berry','Gastly':'Ingredient', 'Haunter':'Ingredient', 
            'Gengar':'Ingredient','Onix':'Berry','Cubone':'Berry', 
            'Marowak':'Berry','Kangaskhan':'Ingredient','Mr. Mime':'Ingredient',
            'Pinsir':'Ingredient','Ditto':'Ingredient','Eevee':'Skill', 
            'Vaporeon':'Skill', 'Jolteon':'Skill', 'Flareon':'Skill',
            'Chikorita':'Berry', 'Bayleef':'Berry', 'Meganium':'Berry',
            'Cyndaquil':'Berry', 'Quilava':'Berry', 'Typhlosion':'Berry',
            'Totodile':'Berry', 'Croconaw':'Berry', 'Feraligatr':'Berry',
            'Pichu':'Berry','Cleffa':'Berry','Igglybuff':'Skill',
            'Togepi':'Skill', 'Togetic':'Skill','Mareep':'Skill', 
            'Flaaffy':'Skill', 'Ampharos':'Skill','Sudowoodo':'Skill',
            'Espeon':'Skill', 'Umbreon':'Skill','Slowking':'Ingredient',
            'Wobbuffet':'Skill','Steelix':'Berry','Heracross':'Skill',
            'Delibird':'Ingredient','Houndour':'Berry', 'Houndoom':'Berry',
            'Larvitar':'Ingredient', 'Pupitar':'Ingredient', 'Tyranitar':'Ingredient',
            'Slakoth':'Berry', 'Vigoroth':'Berry', 'Slaking':'Berry',
            'Sableye':'Skill','Gulpin':'Skill', 'Swalot':'Skill',
            'Swablu':'Berry', 'Altaria':'Berry','Shuppet':'Berry', 
            'Banette':'Berry', 'Absol':'Ingredient','Wynaut':'Skill',
            'Spheal':'Berry', 'Sealeo':'Berry', 'Walrein':'Berry',
            'Bonsly':'Skill','Mime Jr.':'Ingredient','Riolu':'Skill', 
            'Lucario':'Skill','Croagunk':'Ingredient', 'Toxicroak':'Ingredient',
            'Snover':'Ingredient', 'Abomasnow':'Ingredient','Magnezone':'Skill',
            'Togekiss':'Skill','Leafeon':'Skill', 'Glaceon':'Skill',
            'Sylveon':'Skill'
        }

        SPECIALTY_CODES = {
            'Berry': 0,
            'Ingredient': 1,
            'Skill': 2,
            'Allrounder': 3
        }

        NATURE_PER_SPECIALTY = {
            'Adamant': [1.0, 0.1, 0.7, 0.4],
            'Bashful': [0.5, 0.5, 0.5, 0.5],
            'Bold': [0.0, 0.1, 0.1, 0.1],
            'Brave': [0.9, 0.5, 0.5, 0.5],
            'Calm': [0.0, 0.1, 0.6, 0.3],
            'Careful': [0.6, 0.1, 1.0, 0.4],
            'Docile': [0.5, 0.5, 0.5, 0.5],
            'Gentle': [0.5, 0.5, 0.9, 0.6],
            'Hardy': [0.5, 0.5, 0.5, 0.5],
            'Hasty': [0.5, 0.5, 0.5, 0.5],
            'Impish': [0.5, 0.0, 0.5, 0.5],
            'Jolly': [0.7, 0.1, 0.5, 0.2],
            'Lax': [0.5, 0.5, 0.0, 0.2],
            'Lonely': [0.9, 0.5, 0.5, 0.5],
            'Mild': [0.1, 0.9, 0.2, 1.0],
            'Modest': [0.0, 0.7, 0.1, 0.3],
            'Naive': [0.5, 0.5, 0.1, 0.2],
            'Naughty': [0.9, 0.7, 0.2, 0.5],
            'Quiet': [0.1, 1.0, 0.2, 0.9],
            'Quirky': [0.5, 0.5, 0.5, 0.5],
            'Rash': [0.1, 1.0, 0.0, 0.5],
            'Relaxed': [0.4, 0.4, 0.4, 0.4],
            'Sassy': [0.2, 0.2, 1.0, 0.6],
            'Serious': [0.5, 0.5, 0.5, 0.5],
            'Timid': [0.0, 0.1, 0.1, 0.1]
        }

        SUBSKILL_PER_SPECIALTY = {
            'Berry Finding S': [1.0, 0.5, 0.8, 0.8],
            'Dream Shard Bonus': [0.3, 0.6, 0.6, 0.6],
            'Energy Recovery Bonus': [0.3, 0.6, 0.6, 0.6],
            'Helping Bonus': [0.5, 1.0, 1.0, 1.0],
            'Helping Speed S': [0.4, 0.5, 0.6, 0.6],
            'Helping Speed M': [0.5, 0.7, 0.8, 0.8],
            'Ingredient Finder S': [0.0, 0.8, 0.0, 0.6],
            'Ingredient Finder M': [0.0, 1.0, 0.1, 0.7],
            'Inventory Up S': [0.1, 0.6, 0.5, 0.6],
            'Inventory Up M': [0.1, 0.7, 0.6, 0.7],
            'Inventory Up L': [0.1, 0.8, 0.7, 0.8],
            'Research EXP Bonus': [0.3, 0.6, 0.6, 0.6],
            'Skill Level Up S': [0.3, 0.5, 0.8, 0.7],
            'Skill Level Up M': [0.4, 0.6, 0.9, 0.8],
            'Skill Trigger S': [0.2, 0.4, 0.9, 0.7],
            'Skill Trigger M': [0.3, 0.5, 1, 0.8],
            'Sleep EXP Bonus': [0.3, 0.6, 0.6, 0.6]
        }

        SPECIES_TO_TIERLIST = {
            'Bulbasaur':0.8, 'Ivysaur':0.8, 'Venusaur':0.8,
            'Charmander':1.0, 'Charmeleon':1.0, 'Charizard':1.0,
            'Squirtle':1.0, 'Wartortle':1.0, 'Blastoise':1.0,
            'Caterpie':0.6, 'Metapod':0.6, 'Butterfree':0.6,
            'Rattata':0.4, 'Raticate':0.4,'Ekans':0.2, 
            'Arbok':0.2,'Pikachu':1.0, 'Raichu':1.0,
            'Pikachu - Halloween':0.4,'Pikachu - Holiday':0.4,'Clefairy':0.6, 
            'Clefable':0.6,'Jigglypuff':1.0, 'Wigglytuff':1.0,
            'Diglett':0.6, 'Dugtrio':0.6,'Meowth':0.0, 
            'Persian':0.0, 'Psyduck':0.0, 'Golduck':0.0,
            'Mankey':0.6, 'Primeape':0.6,'Growlithe':0.4, 
            'Arcanine':0.4,'Bellsprout':0.8, 'Weepinbell':0.8, 
            'Victreebel':0.8,'Geodude':0.8, 'Graveler':0.8, 
            'Golem':0.8, 'Slowpoke':0.2, 'Slowbro':0.2,
            'Magnemite':0.4, 'Magneton':0.4,'Doduo':0.8, 
            'Dodrio':0.8,'Gastly':0.8, 'Haunter':0.8, 
            'Gengar':0.8,'Onix':0.8,'Cubone':0.4, 
            'Marowak':0.4,'Kangaskhan':0.4,'Mr. Mime':0.6,
            'Pinsir':1.0,'Ditto':0.6,'Eevee':1.0, 
            'Vaporeon':0.8, 'Jolteon':0.4, 'Flareon':0.6,
            'Chikorita':1.0, 'Bayleef':1.0, 'Meganium':1.0,
            'Cyndaquil':1.0, 'Quilava':1.0, 'Typhlosion':1.0,
            'Totodile':1.0, 'Croconaw':1.0, 'Feraligatr':1.0,
            'Pichu':1.0,'Cleffa':0.6,'Igglybuff':1.0,
            'Togepi':0.2, 'Togetic':0.2,'Mareep':0.4, 
            'Flaaffy':0.4, 'Ampharos':0.4,'Sudowoodo':0.0,
            'Espeon':0.6, 'Umbreon':0.2,'Slowking':0.2,
            'Wobbuffet':0.0,'Steelix':0.6,'Heracross':0.4,
            'Delibird':0.8,'Houndour':0.8, 'Houndoom':0.8,
            'Larvitar':0.8, 'Pupitar':0.8, 'Tyranitar':0.8,
            'Slakoth':0.8, 'Vigoroth':0.8, 'Slaking':0.8,
            'Sableye':0.0,'Gulpin':0.0, 'Swalot':0.0,
            'Swablu':0.4, 'Altaria':0.4,'Shuppet':0.6, 
            'Banette':0.6, 'Absol':0.8,'Wynaut':0.0,
            'Spheal':1.0, 'Sealeo':1.0, 'Walrein':1.0,
            'Bonsly':0.0,'Mime Jr.':0.0,'Riolu':0.0, 
            'Lucario':0.0,'Croagunk':0.2, 'Toxicroak':0.2,
            'Snover':0.8, 'Abomasnow':0.8,'Magnezone':0.4,
            'Togekiss':0.2,'Leafeon':0.0, 'Glaceon':0.6,
            'Sylveon':1.0
        }

        SUBSKILL_UNLOCK_WEIGHTS = [1, 0.9, 0.6, 0.3, 0.2]

        RATING_WEIGHTS = [
            [0.2, 0.6, 0, 0.2],  # berry
            [0.1, 0.4, 0.3, 0.2],  # ingredient
            [0.2, 0.6, 0, 0.2],  # skill
            [0.1, 0.5, 0.2, 0.2]  # allrounder
        ]

        NATURE_XP_FACTOR = 0.3

        ING_SPECIES = [species for species, specialty in SPECIES_TO_SPECIALTY.items() if specialty == 'Ingredient']

        XP_HARD_SPECIES = [
            'Onix', 'Kangaskhan', 'Pinsir','Ditto','Steelix','Heracross',
            'Delibird','Larvitar', 'Pupitar', 'Tyranitar', 'Absol'
        ]

        XP_NATURE_UP = ['Timid', 'Hasty', 'Jolly', 'Naive']
        XP_NATURE_DOWN = ['Brave', 'Relaxed', 'Quiet', 'Sassy']

        def __init__(self, species, nature, ss10, ss25, ss50, ss75, ss100, ing30, ing60):
            self.species = species
            self.nature = nature 
            self.ss10 = ss10 
            self.ss25 = ss25 
            self.ss50 = ss50 
            self.ss75 = ss75 
            self.ss100 = ss100 
            self.ing30 = ing30 
            self.ing60 = ing60 
            self.match_specialty()

        def match_specialty(self):
            try:
                self.specialty = pokemonRater.SPECIES_TO_SPECIALTY[self.species]
                self.specialty_code = pokemonRater.SPECIALTY_CODES[self.specialty]
            except KeyError:
                Element('warning').write(f"No Pokemon selected")

        def rate_nature(self):
            try:
                self.nature_rating = pokemonRater.NATURE_PER_SPECIALTY[self.nature][self.specialty_code]
                if self.species in pokemonRater.XP_HARD_SPECIES:
                    if self.nature in pokemonRater.XP_NATURE_UP:
                        nature_rating_corrected = self.nature_rating + pokemonRater.NATURE_XP_FACTOR
                        self.nature_rating = 1.0 if nature_rating_corrected > 1.0 else nature_rating_corrected
                    if self.nature in pokemonRater.XP_NATURE_DOWN:
                        nature_rating_corrected = self.nature_rating - pokemonRater.NATURE_XP_FACTOR
                        self.nature_rating = 0.0 if nature_rating_corrected < 0.0 else nature_rating_corrected
            except KeyError:
                Element('warning').write(f"No nature selected")

        def _get_subskill_score_bounds(self):
            all_scores_per_speciality = [subskill_ratings[self.specialty_code] for subskill_ratings in pokemonRater.SUBSKILL_PER_SPECIALTY.values()]
            subskill_scores_sorted = sorted(all_scores_per_speciality, reverse=True)
            largest_5_scores = subskill_scores_sorted[:5]
            smallest_5_scores = subskill_scores_sorted[-5:]
            self.max_subskill_score = sum([score*weight for score, weight in zip(largest_5_scores, pokemonRater.SUBSKILL_UNLOCK_WEIGHTS)])
            self.min_subskill_score = sum([score*weight for score, weight in zip(sorted(smallest_5_scores), pokemonRater.SUBSKILL_UNLOCK_WEIGHTS)]) 
    
        def rate_subskills(self):
            subskills = [self.ss10, self.ss25, self.ss50, self.ss75, self.ss100]
            try:
                subskills_unweighted = [pokemonRater.SUBSKILL_PER_SPECIALTY[subskill][self.specialty_code] for subskill in subskills]
                subskills_weighted = [score*weight for score, weight in zip(subskills_unweighted, pokemonRater.SUBSKILL_UNLOCK_WEIGHTS)]
                self._get_subskill_score_bounds()
                self.subskill_rating = (sum(subskills_weighted) - self.min_subskill_score) / (self.max_subskill_score - self.min_subskill_score)
            except KeyError:
                Element('warning').write(f"Not all subskills selected")

        def rate_ingredients(self):  # TODO
            self.ingredient_rating = 0.5

        def rate_tierlist(self):
            try:
                self.tierlist_rating = pokemonRater.SPECIES_TO_TIERLIST[self.species]
            except KeyError:
                Element('warning').write(f"No Pokemon selected")

        def combine_scores(self):
            rating_weights = pokemonRater.RATING_WEIGHTS[self.specialty_code]
            subscores = [self.nature_rating, self.subskill_rating, self.ingredient_rating, self.tierlist_rating]
            self.score = sum([weight * subscore for weight, subscore in zip(rating_weights, subscores)])
        
        def apply_feelgoodfactor(self):
            k = 8
            self.score = 1 / (1 + math.exp(-k * (self.score - 0.5)))

        def rate_pokemon(self):
            try:
                self.rate_nature()
                self.rate_subskills()
                self.rate_ingredients()
                self.rate_tierlist()
                self.combine_scores()
                self.apply_feelgoodfactor()
                Element('warning').write(f"")
                if self.species in pokemonRater.ING_SPECIES:
                    Element('score').write(f"Sorry, I can't rate ingredient Pokkies yet")
                else:
                    Element('score').write(f'Final score of {self.species} is: {round(self.score*100, 1)}%')
            except AttributeError:
                Element('score').write(f"Data missing. Please fill required fields")
    
    def _extract_stats():
        return {
            'species':Element('species').value,
            'nature':Element('nature').value,
            'ss10':Element('ss10').value,
            'ss25':Element('ss25').value,
            'ss50':Element('ss50').value,
            'ss75':Element('ss75').value,
            'ss100':Element('ss100').value,
            'ing30':Element('ing30').value,
            'ing60':Element('ing60').value
        }
    
    def evaluate():
        species = Element('species').value
        stats = _extract_stats()
        pokemonRater(**stats).rate_pokemon()

        
</py-script>
</html>
